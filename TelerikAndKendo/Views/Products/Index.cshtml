@* Views/Home/Index.cshtml *@
@{
    ViewBag.Title = "Tableau de Bord - Gestion des Produits";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles {
    <style>
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-left: 4px solid #3f51b5;
        }

            .stat-card i {
                font-size: 24px;
                color: #3f51b5;
                margin-bottom: 10px;
            }

            .stat-card h3 {
                margin: 0;
                color: #333;
                font-size: 28px;
            }

            .stat-card p {
                margin: 5px 0 0;
                color: #666;
            }

        .dashboard-widgets {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @@media (max-width: 992px) {
            .dashboard-widgets {
                grid-template-columns: 1fr;
            }
        }
    </style>
}

<div class="dashboard-stats">
    <div class="stat-card">
        <i class="fas fa-box"></i>
        <h3 id="total-products">0</h3>
        <p>Produits Totaux</p>
    </div>

    <div class="stat-card">
        <i class="fas fa-check-circle"></i>
        <h3 id="in-stock">0</h3>
        <p>En Stock</p>
    </div>

    <div class="stat-card">
        <i class="fas fa-times-circle"></i>
        <h3 id="out-of-stock">0</h3>
        <p>Rupture de Stock</p>
    </div>

    <div class="stat-card">
        <i class="fas fa-chart-line"></i>
        <h3 id="total-value">0 €</h3>
        <p>Valeur Totale</p>
    </div>
</div>

<div class="dashboard-widgets">
    <div>
        <h3><i class="fas fa-table"></i> Liste des Produits</h3>
        <div id="products-grid"></div>
    </div>

    <div>
        <h3><i class="fas fa-chart-pie"></i> Statistiques par Catégorie</h3>
        <div id="category-chart" style="height: 300px;"></div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function() {
        // 1. Configuration du DataSource pour la Grid
        var productsDataSource = new kendo.data.DataSource({
            transport: {
                read: {
                    url: '@Url.Action("GetProducts", "Products")',
                    type: "GET",
                    dataType: "json"
                }
            },
            schema: {
                data: "data",
                total: "total"
            },
            pageSize: 5,
            serverPaging: true,
            serverSorting: true,
            serverFiltering: true,
            change: function() {
                updateDashboardStats(this.data());
            }
        });

        // 2. Initialisation de la Grid Kendo
        $("#products-grid").kendoGrid({
            dataSource: productsDataSource,
            height: 400,
            pageable: {
                refresh: true,
                pageSizes: [5, 10, 20]
            },
            sortable: true,
            filterable: true,
            columns: [
                { field: "Name", title: "Nom" },
                { field: "Category", title: "Catégorie" },
                { field: "Price", title: "Prix", format: "{0:c}" },
                { field: "Quantity", title: "Quantité" },
                {
                    field: "InStock",
                    title: "Stock",
                    template: '#= InStock ? "<span class=\'badge bg-success\'>En stock</span>" : "<span class=\'badge bg-danger\'>Rupture</span>" #'
                }
            ],
            toolbar: [
                {
                    template: '<a href="@Url.Action("Index", "Products")" class="k-button k-button-icontext">' +
                             '<span class="k-icon k-i-grid"></span>Voir tous les produits</a>'
                }
            ]
        });

        // 3. Initialisation du graphique Kendo
        $("#category-chart").kendoChart({
            dataSource: {
                transport: {
                    read: {
                        url: '@Url.Action("GetCategoryStats", "Products")',
                        dataType: "json"
                    }
                }
            },
            legend: {
                position: "bottom"
            },
            seriesDefaults: {
                type: "pie",
                labels: {
                    visible: true,
                    template: "#= category #: #= value # produits",
                    position: "outsideEnd"
                }
            },
            series: [{
                field: "count",
                categoryField: "category",
                explodeField: "explode"
            }],
            tooltip: {
                visible: true,
                template: "#= category #: #= value # produits"
            }
        });

        // 4. Fonction pour mettre à jour les statistiques du dashboard
        function updateDashboardStats(products) {
            var totalProducts = products.length;
            var inStock = products.filter(p => p.InStock).length;
            var outOfStock = totalProducts - inStock;
            var totalValue = products.reduce((sum, p) => sum + (p.Price * p.Quantity), 0);

            $("#total-products").text(totalProducts);
            $("#in-stock").text(inStock);
            $("#out-of-stock").text(outOfStock);
            $("#total-value").text(totalValue.toFixed(2) + " €");
        }

        // 5. Charger les données initiales
        productsDataSource.read();
    });
    </script>
}